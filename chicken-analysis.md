# Анализ системы курицы в Stationeers

## Обзор архитектуры

Курица в Stationeers реализована через иерархию классов:
```
Thing (базовый класс для всех объектов)
  └── DynamicThing (объекты с физикой)
      └── Entity (живые существа)
          └── Npc (неигровые персонажи)
              └── Animal (животные)
                  └── Chicken (курица)
```

## Класс Chicken

### Основные характеристики
- **Наследует от:** `Animal`
- **Основная функция:** Откладывание яиц
- **Максимальное количество:** 100 куриц одновременно
- **Базовое хранилище питания:** 25 единиц

### Ключевые поля и свойства
```csharp
public FertilizedEgg FertilizedEggPrefab;     // Префаб оплодотворенного яйца
public DynamicThing EggPrefab;                // Префаб обычного яйца
public Transform EggSpawn;                    // Точка спавна яиц
public static List<Chicken> AllChickens;     // Список всех куриц
private float _eggTimeDefault = GameManager.TicksPerDay;  // Время между откладыванием яиц
private float _layEggTimer;                   // Таймер откладывания яиц
public override Lungs LungsPrefab => Prefab.Organ.LungsChicken;  // Легкие курицы
```

### Основные методы

#### Awake()
- Добавляет курицу в глобальный список `AllChickens`
- Инициализирует систему костей (RigRoot)
- Устанавливает случайный таймер откладывания яиц

#### LifeNutrition()
- Потребляет питание: `BaseNutritionStorage / GameManager.TicksPerDay` за тик
- Только если курица не искусственная (`!IsArtificial`)

#### HandleStateTimer()
- Уменьшает таймер откладывания яиц (`_layEggTimer`)

#### LayEgg()
- Создает оплодотворенное яйцо в позиции `EggSpawn`
- Добавляет физические силы яйцу (толчок и вращение)
- Сбрасывает таймер на случайное время (75%-125% от базового)
- Тратит половину питания, необходимого для откладывания яйца
- Активирует анимацию через `InteractOnOff`

#### PerformState()
- Проверяет, пора ли откладывать яйцо (`_layEggTimer <= 0.1f`)
- Если недостаточно питания, переходит в состояние поиска еды
- Если питания достаточно, начинает процесс откладывания яйца

## Класс Animal (базовый для всех животных)

### Состояния животного
```csharp
public enum AnimalStateEnum
{
    Idle,   // Бездействие
    Roam,   // Блуждание
    Eat,    // Поедание
    Poop    // Испражнение
}
```

### Ключевые системы

#### Система дыхания
- Использует `LungsPrefab` для создания легких
- Заполняет легкие кислородом при создании жизни
- Наследует дыхательную систему от Entity

#### Система питания
- Ищет еду когда питание < 0.3 и есть доступная еда
- Использует `Plant.AllEdibles` для поиска съедобных растений
- Потребляет питание через `_targetFood.GetNutritionValue()`

#### Система навигации
- Использует `PathList` для движения по миру
- Регистрирует задачи поиска пути через `RoomManager`
- Может искать еду (`RegisterFoodPathFindingTask`) или случайные точки

#### Система состояний
- Переключается между состояниями на основе потребностей
- Управляет таймерами состояний
- Обрабатывает потерю сознания при критическом уроне мозга

### Жизненный цикл
- `LifeSpanInDays` - продолжительность жизни в днях
- При достижении 0 дней получает урон 10 единиц
- Может умереть от старости

## Класс Npc (базовый для NPC)

### Система движения
```csharp
public float Acceleration = 4f;      // Ускорение
public float MaxSpeed = 2f;          // Максимальная скорость
public float TurnSpeed = 3f;         // Скорость поворота
public float JumpStrength = 1f;      // Сила прыжка
```

### Навигация
- Использует `GridPathfinder.NpcPathGrid` для построения пути
- Обрабатывает движение с гравитацией и без неё
- Автоматически прыгает при застревании
- Имеет таймаут для сброса пути (5 секунд)

### Анимация
- Управляет аниматором через хеши параметров
- `VelocityHash` - скорость движения
- `AliveHash` - состояние жизни

## Класс Entity (базовый для всех живых существ)

### Жизненные показатели
```csharp
public float Nutrition;              // Питание (0-BaseNutritionStorage)
public float Hydration;              // Гидратация (0-8.75)
public float Oxygenation;            // Кислородное насыщение (0-MaxOxygenStorage)
public float Mood;                   // Настроение (0-1)
public float Hygiene;                // Гигиена (0-1.25)
public float FoodQuality;            // Качество пищи (0-1)
```

### Состояния сущности
```csharp
public enum EntityState : byte
{
    Alive,        // Живой
    Dead,         // Мертвый
    Unconscious,  // Без сознания
    Decay         // Разложение
}
```

### Система дыхания
- Потребляет 0.0048 моль кислорода за вдох
- Выделяет CO2 в атмосферу
- Рассчитывает эффективность дыхания на основе парциального давления O2
- Получает урон от токсичных газов

### Система органов
- `BrainSlot` и `LungsSlot` для размещения органов
- `OrganBrain` и `OrganLungs` - ссылки на органы
- Список всех органов в `Organs`

### Система урона
- `EntityDamageState` для отслеживания различных типов урона
- Автоматическое получение урона от голода, обезвоживания, недостатка кислорода
- Потеря сознания при критическом уроне мозга

## Системы сохранения

### ChickenSaveData
```csharp
public class ChickenSaveData : EntitySaveData
{
    public float EggTimeDefault = float.NaN;  // Базовое время откладывания яиц
    public float LayEggTimer;                 // Текущий таймер откладывания
}
```

## Интеграция с игровыми системами

### Атмосферная система
- Взаимодействует с `Atmosphere` для дыхания
- Использует `AtmosphericEventInstance` для изменения газовых смесей
- Реагирует на качество воздуха и давление

### Система сетки (Grid System)
- Использует `GridController` для навигации
- `WorldGrid` и `GridPosition` для позиционирования
- Интеграция с `RoomManager` для поиска пути

### Система инвентаря
- Может быть помещена в слоты через `Slot` систему
- Поддерживает перетаскивание (`IDraggable`)
- Взаимодействие с контейнерами

### Система физики
- Наследует от `DynamicThing` физические свойства
- `RigidBody` для физического взаимодействия
- Коллайдеры для обнаружения столкновений

## Рекомендации для создания НПЦ

### Что можно использовать напрямую:
1. **Базовую архитектуру Entity → Npc** - полная система жизни
2. **Систему дыхания** - готовая реализация потребления O2 и выделения CO2
3. **Систему навигации** - движение по сетке и поиск пути
4. **Систему состояний** - управление поведением
5. **Систему органов** - мозг и легкие
6. **Систему сохранения** - автоматическое сохранение состояния

### Что нужно адаптировать:
1. **Специфическое поведение** - заменить откладывание яиц на целевые задачи
2. **Параметры движения** - скорость, ускорение под человеческие значения
3. **Систему питания** - адаптировать под человеческие потребности
4. **Визуальную модель** - заменить модель курицы на человеческую
5. **Анимации** - человеческие анимации вместо куриных

### Ключевые точки интеграции:
1. **Атмосферная система** - готова для реакции на газы
2. **Температурная система** - через `IThermal` интерфейс
3. **Система урона** - `EntityDamageState` поддерживает все типы урона
4. **UI система** - `GetExtendedText()` для отображения информации
5. **Система взаимодействий** - `AttackWith()` для инструментов

## Мод клонирования куриц

### Обзор
Создан мод `ChickenCloningMod`, который позволяет клонировать куриц с помощью CryoTube.

### Принцип работы
1. **CryoTube как инкубатор**: Используется существующий объект CryoTube для процесса клонирования
2. **Условия активации**:
   - CryoTube включен (On = true)
   - Setting установлен на константу 5
   - CryoTube открыт (Open = true)
   - Подключено электричество (Powered = true)
   - CryoTube пустой (нет предметов в слотах)
3. **Процесс клонирования**: 60-секундный обратный отсчет (конфигурируемый параметр)
4. **Отображение прогресса**: "Cloning: X%" или "Waiting command"
5. **Результат**: Создание новой курицы рядом с CryoTube

### Архитектура мода

#### ChickenCloningMod.cs
- Основной класс мода с BepInEx
- Конфигурируемый параметр `CloningDuration` (по умолчанию 60 секунд)
- Инициализация Harmony патчей

#### CryoTubePatch.cs
- Патч для `CryoTube.OnAtmosphericTick()`
- Система состояний клонирования (`CloningState`)
- Проверка условий и управление таймером
- Обновление дисплеев

#### ChickenSpawner.cs
- Создание куриц в мире
- Поиск безопасной позиции для спавна
- Инициализация созданных куриц
- Интеграция с сетевой системой

#### DisplayManager.cs
- Управление связанными дисплеями
- Поиск дисплеев в радиусе и по сети
- Обновление информации на дисплеях

### Интеграция с игровыми системами

#### Система электричества
- Проверка `cryoTube.Powered` для активации
- Поиск дисплеев через `PowerNetwork`

#### Система слотов
- Проверка `ImportSlots` на наличие предметов
- Обеспечение пустого состояния CryoTube

#### Система дисплеев
- Автоматический поиск связанных `ConsoleDisplay`
- Обновление через сеть и прямое подключение

#### Система спавна
- Использование `Object.Instantiate()` для создания куриц
- Интеграция с `NetworkServer.Spawn()` для мультиплеера
- Физическая проверка позиций через `Physics.OverlapSphere()`

### Преимущества подхода
1. **Использование существующих объектов**: Не требует новых префабов
2. **Интеграция с UI**: Автоматическое отображение на дисплеях
3. **Конфигурируемость**: Время клонирования можно настроить
4. **Безопасность**: Проверка всех условий перед активацией
5. **Производительность**: Эффективное управление состоянием

### Возможные расширения
1. **Ресурсы для клонирования**: Требование материалов (ДНК, энергия)
2. **Различные животные**: Поддержка клонирования других существ
3. **Генетические мутации**: Случайные изменения у клонов
4. **Ограничения**: Максимальное количество клонов
5. **Интеграция с исследованиями**: Требование технологий

## Заключение

Система курицы предоставляет отличную основу для создания НПЦ, так как уже включает:
- Полную систему жизнеобеспечения (дыхание, питание, гидратация)
- Интеллектуальное поведение (поиск еды, навигация)
- Реакцию на окружающую среду (атмосфера, температура)
- Систему состояний и анимации
- Интеграцию со всеми игровыми системами

Мод клонирования куриц демонстрирует, как можно расширить игровую механику, используя существующие системы и объекты. Основная задача для НПЦ - заменить куриное поведение (откладывание яиц) на человеческие цели и адаптировать параметры под человеческие потребности.